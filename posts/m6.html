<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>My model for the M6 forecasting competition | Pass the ROC</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../rss.xml">
<link rel="canonical" href="http://danielweitzenfeld.github.io/passtheroc/posts/m6.html">
<!--[if lt IE 9]><script src="../assets/js/html5.js"></script><![endif]--><meta name="author" content="Dan Weitzenfeld">
<link rel="prev" href="xg_and_game_sitch.html" title="Accounting for Game Situation When Using xG to Evaluate Team Strength" type="text/html">
<meta property="og:site_name" content="Pass the ROC">
<meta property="og:title" content="My model for the M6 forecasting competition">
<meta property="og:url" content="http://danielweitzenfeld.github.io/passtheroc/posts/m6.html">
<meta property="og:description" content="The M6 Financial Forecasting Competition had two components: forecasting and investing.  Over 12 months (technically 12 4-week periods), participants had to:

forecast the probability that each of the">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-02-20T12:00:00Z">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../">

            <span id="blog-title">Pass the ROC</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../pages/about.html" class="nav-link">About</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="m6.ipynb" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">My model for the M6 forecasting competition</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Dan Weitzenfeld
            </span></p>
            <p class="dateline">
            <a href="#" rel="bookmark">
            <time class="published dt-published" datetime="2023-02-20T12:00:00Z" itemprop="datePublished" title="2023-02-20 12:00">2023-02-20 12:00</time></a>
            </p>
            
        <p class="sourceline"><a href="m6.ipynb" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The M6 Financial Forecasting Competition had two components: forecasting and investing.  Over 12 months (technically 12 4-week periods), participants had to:</p>
<ul>
<li>forecast the probability that each of the 100 assets would have returns in the 1st quantile, 2nd quantile, etc. that month.  This was the "forecasting" component.</li>
<li>build a portfolio from the 100 assets to hold for the month (the "decisions" component).</li>
</ul>
<p>The forecasting component was scored by ranked probability score; the decisions component was scored by information ratio.</p>
<p>I came in 1st by a hair's breadth in the forecasting component. The margins at the top were incredibly close, and the competition was only 12 months, so this is far from enough evidence to conclude that my model was the best.</p>
<p>In this post, I'll describe my model and thought process.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Initial-thoughts">Initial thoughts<a class="anchor-link" href="m6.html#Initial-thoughts">¶</a>
</h4>
<p>My intuition was that the forecasting component would come down to correctly modeling volatility, not picking winners and losers.  I don't believe markets are perfectly efficient, but I also didn't believe a contest like this would attract or unearth a diamond-in-the-rough stock-picking talent.</p>
<p>My next consideration was what frequency to model.  E.g., I could model daily or weekly returns, and just roll the daily or weekly forecast forward for a month.  But I quickly decided that I would start with the frequency of the competition, monthly.  The problem with modeling at a higher frequency is that any bias in the model will compound over the month.  Think of hitting a golf ball: if your angle is off by 1 degree, you'll sink a 1 foot putt but you'll miss a 30-footer.    (I did, however, include some features from daily return data - more on this later).</p>
<p>I knew off the bat that I'd use <a href="https://www.pymc.io/welcome.html">pymc</a> to build a Bayesian model.  Bayesian models are built to quantify uncertainty, and probabilistic programming languages like pymc make building complicated Bayesian models easy.  Given the challenge was to model the covariance of 100 assets, I landed on probabilistic PCA as the scaffolding for my model.  I had used it with some success in other, similar applications; PCA is often used in econometric modeling to reduce the dimensionality of the hundreds of macroeconomic data series available.  But I knew I'd need to add some additional bells and whistles for this problem.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Modeling-$%5Cmu$">Modeling $\mu$<a class="anchor-link" href="m6.html#Modeling-%24%5Cmu%24">¶</a>
</h4>
<p>The $\mu_i$ for each asset $i$ is the sum of:</p>
<ul>
<li>the asset's loadings times the factors, $w_i * \lambda_t$.  I somewhat arbitrarily chose 7 factors, and modeled their dynamics as AR(1). I used static loadings.</li>
<li>$\beta_{recent\_returns_i}$ multiplied by the asset's return in the final week of the prior month.  These betas were drawn from one of three heirarchical distributions: one for stocks, one for equity ETFs, and one for fixed-income ETFs (hereafter "asset classes").</li>
<li>an asset-specific intercept, $\alpha_i$. In practice, these were all near zero because the rest of the model explained most of the variance.</li>
</ul>
<p>The AR coefficient for the factors was slightly negative, and this puzzled me for a long while. It turns out I had stumbled across the short-term reversal anomaly - see <a href="https://quantpedia.com/strategies/short-term-reversal-in-stocks/">here</a> or <a href="https://www.newyorkfed.org/medialibrary/media/research/staff_reports/sr513.pdf">here</a>.</p>
<p>The remainder of the model is for the noise around $\mu$, which is symmetric.  This means that the only mechanisms by which the model could independently forecast "winners and losers" are the three above: factor dynamics (effectively short-term reversal); returns in the last week of the prior month; and asset-specific intercepts.  As a result, the model's forecasts were nearly symmetric: the probability of an asset being in the bottom quantile was close to the probability of it being in the top quantile.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Modeling-noise-around-$%5Cmu$">Modeling noise around $\mu$<a class="anchor-link" href="m6.html#Modeling-noise-around-%24%5Cmu%24">¶</a>
</h4>
<p>The observation noise around $\mu$ is t-distributed.  The degrees of freedom $\nu_i$ is drawn from a hierarchical distribution. $\sigma_{it}$ is the sum of:</p>
<ul>
<li>$\theta_{0i}$, a baseline noise for each asset.  Drawn from a one of three hierarchical distributions, one per asset class.</li>
<li>$\theta_{recentvol_i}$ times the daily volatility of the asset in the last week of the prior month, normalized at the asset level by its past values. Also drawn from one of three hierarchical distributions.</li>
<li>$\theta_{earnings_i}$ times a dummy for whether the asset announced earnings in the month.  Drawn from a hierarchical distribution.</li>
</ul>
<p>That's it, that's the model.  I added observation weights to weight the recent past more heavily than the distant past, and fit the model on the last 8 years of data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="From-posterior-samples-to-a-forecast">From posterior samples to a forecast<a class="anchor-link" href="m6.html#From-posterior-samples-to-a-forecast">¶</a>
</h4>
<p>One benefit of using a tool like pymc to make forecasts is that in many cases, <em>inference (or sampling) is forecasting.</em>  Just pass missing data to the observed variable, and pymc performs automatic imputation.  The future is, of course, missing, so I passed it in and got 4000 samples from the posterior distribution of the future, conditional on the data we have observed and, of course, on my model being the correct one.</p>
<p>A second benefit revealed itself midway through the competition when one of the 100 assets (DRE) went defunct.  The organizers said they would handle it by <del>forgetting about DRE</del> pretending DRE had a return of zero in each remaining month.  This was easy for me to account for: all I did was set DRE's return to zero in each of the 4000 samples before taking the quantile probabilities.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Probabilistic-judgmental-forecast,-and-a-stroke-of-luck">Probabilistic judgmental forecast, and a stroke of luck<a class="anchor-link" href="m6.html#Probabilistic-judgmental-forecast,-and-a-stroke-of-luck">¶</a>
</h4>
<p>I baked in the option to input "probabilistic judgmental forecasts" for the forecast period.  I could tell the model, for example, that the return on XLP in the forecast period would be 2% with a standard deviation of 2 percentage points.  The model would then give me the posterior distribution for all 100 assets conditional on this probabilistic forecast.</p>
<p>The competition had a trial month before the scores mattered, and I submitted an entry for the trial month, without using this probabilistic judgemental forecast function of my model.  Then came the first real month of the competition, which started in late February. I naively predicted that Russia's invasion of Ukraine would be over quickly, and put my thumb on the scale in a direction that I thought be consistent with such an outcome.  But timezones are hard and I missed the submission deadline by a few hours, so my entry for the trial month carried over to the first official month.  My prediction about Russia's invasion was, of course, horribly wrong, and my submission from the trial month actually had a better RPS than the submission I wanted to make.</p>
<p>My takeaway was clear:  I cannot predict the future and should not try.  For the remainder of the competition, I did not use the probabilistic judgemental forecast function of my model again.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Closing-thoughts">Closing thoughts<a class="anchor-link" href="m6.html#Closing-thoughts">¶</a>
</h4>
<p>The M6 competition had quarterly prizes as well.  I did not win any.  Indeed, among the top 3 for the year-long forecasting, none of us placed in any of the quarters. None of the quarterly winners placed more than once. It takes many draws to assess the quality of probabilistic forecasting.</p>

</div>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="xg_and_game_sitch.html" rel="prev" title="Accounting for Game Situation When Using xG to Evaluate Team Strength">Previous post</a>
            </li>
        </ul></nav></aside><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-3lJUsx1TJHt7BA4udB5KPnDrlkO8T6J6v/op7ui0BbCjvZ9WqV4Xm6DTP6kQ/iBH" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
    },
    displayAlign: 'center', // Change this to 'left' if you want left-aligned equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script></article><!--End of body content--><footer id="footer">
            Contents © 2023         <a href="mailto:dweitzenfeld@gmail.com">Dan Weitzenfeld</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
